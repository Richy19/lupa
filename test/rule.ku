class Macro {

    rule text {
        {~ <item>* ~}
    }
    rule item {
        <macro> | [^()] | '(' <item>* ')'
    }
    rule arg {
        ' '* {~ (!',' <item>)* ~}
    }
    rule args {
        '(' <arg> (',' <arg>)* ')'
    }
    rule macro {
        | ('apply' <args>) -> '%1(%2)'
        | ('add'   <args>) -> '%1 + %2'
        | ('mul'   <args>) -> '%1 * %2'
    }
    method parse(str) {
        return str =~ self.text
    }
}

var a = / '42' /
print("42" =~ / { 'answer' | <{a}> } /)

var m = Macro.new()
var s = "add(mul(a,b),apply(f,x))"
//print(m.text)
print("MATCH:", s, "=>", m.parse(s))
